<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cinematic Slideshow Engine</title>
    <style>
        :root {
            --blur-amount: 8px;        
            --saturation: 110%;          
            --brightness: 90%;          
            --animation-speed: 40s;      
            --transition-speed: 3.0s; /* Tijd voor crossfade tussen slides */
        }

        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #000; overflow: hidden; }
        #bg-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; }
        
        /* Zwarte laag voor als muziek stopt */
        #fade-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: #000; opacity: 0; z-index: 100; pointer-events: none; 
            transition: opacity 2s ease-in-out; 
        }
        #fade-overlay.black { opacity: 1; }

        /* De achtergrondlagen (Slideshow & Cover Art) */
        .bg-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; z-index: 1;
            /* Filter voor dat "Liquid Glass" effect */
            filter: url(#liquid-glass) blur(var(--blur-amount)) saturate(var(--saturation)) brightness(var(--brightness));
            transform: scale(1.1); will-change: transform, opacity;
        }

        /* Langzame zoom beweging (Ken Burns effect) */
        @keyframes drift { 
            0% { transform: scale(1.1); } 
            100% { transform: scale(1.25); } 
        }

        .bg-layer.active { opacity: 1; z-index: 10; animation: drift var(--animation-speed) infinite alternate ease-in-out; }
        .bg-layer.entering { opacity: 1; z-index: 11; transition: opacity var(--transition-speed) ease-in-out; }
        .bg-layer.exiting { opacity: 0; z-index: 9; transition: opacity var(--transition-speed) ease-in-out; }

        #debug-status { position: fixed; bottom: 10px; left: 10px; color: rgba(255,255,255,0.4); font-family: monospace; font-size: 11px; z-index: 200; pointer-events: none; }
    </style>
</head>
<body>

    <div id="debug-status">Engine Standby</div>

    <div id="bg-container">
        <div id="fade-overlay"></div>
        <img id="bg1" class="bg-layer" src="" alt="">
        <img id="bg2" class="bg-layer" src="" alt="">
    </div>

    <svg style="position: absolute; width: 0; height: 0; overflow: hidden;">
        <defs>
            <filter id="liquid-glass" x="-20%" y="-20%" width="140%" height="140%">
                <feTurbulence type="fractalNoise" baseFrequency="0.015" numOctaves="2" result="noise" />
                <feDisplacementMap in="SourceGraphic" in2="noise" scale="20" xChannelSelector="R" yChannelSelector="G" />
            </filter>
        </defs>
    </svg>

    <script>
        // CONFIGURATIE
        const LASTFM_API_KEY = "6c9c00e45e415acfc71a217c7ba023c8";
        const LASTFM_USER = "Hollander33";
        
        // Pas dit aan naar jouw mapstructuur op GitHub. 
        // Zorg dat in elke map de bestanden 1.jpg, 2.jpg, etc. heten.
        const BASE_IMG_PATH = "./assets/"; 

        const THEMES = [
          { 
            folder: "harry_potter", 
            count: 5, // Aantal foto's in de map (1.jpg t/m 5.jpg)
            match: { artist: ["John Williams", "Alexandre Desplat", "Nicholas Hooper"], album: ["Harry Potter"], track: ["Hedwig", "Hogwarts"] } 
          },
          { 
            folder: "dune", 
            count: 4, 
            match: { artist: ["Hans Zimmer"], album: ["Dune"], track: ["Arrakis", "Paul's Dream", "Worm"] } 
          },
          { 
            folder: "inception", 
            count: 3, 
            match: { artist: ["Hans Zimmer"], album: ["Inception"], track: ["Time", "Dream"] } 
          },
          { 
            folder: "interstellar", 
            count: 5, 
            match: { artist: ["Hans Zimmer"], album: ["Interstellar"], track: ["Cornfield", "No Time for Caution"] } 
          },
          { 
            folder: "tenet", 
            count: 3, 
            match: { artist: ["Ludwig Göransson"], album: ["Tenet"] } 
          },
          { 
            folder: "f1", 
            count: 3, 
            match: { artist: ["Brian Tyler"], album: ["Formula 1", "F1"], track: ["Formula 1", "Verstappen"] } 
          },
          { 
            folder: "batman", 
            count: 4, 
            match: { artist: ["Hans Zimmer"], album: ["Dark Knight", "Batman"], track: ["Molossus", "Gotham"] } 
          },
          { 
             folder: "oppenheimer", 
             count: 3, 
             match: { artist: ["Ludwig Göransson"], album: ["Oppenheimer"], track: ["Destroyer", "Trinity"] }
          }
        ];

        // LOGICA (Niet aanpassen tenzij nodig)
        let currentTrackId = "";
        let activeBgIndex = 1; // 1 of 2
        let idleTimer = null;
        let slideshowTimer = null;
        let isIdle = false;
        
        const debugText = document.getElementById("debug-status");
        const bg1 = document.getElementById("bg1");
        const bg2 = document.getElementById("bg2");
        const fadeOverlay = document.getElementById("fade-overlay");

        function setStatus(msg) { debugText.innerText = msg; console.log(msg); }

        async function fetchLastFm() {
            const url = `https://ws.audioscrobbler.com/2.0/?method=user.getrecenttracks&user=${LASTFM_USER}&api_key=${LASTFM_API_KEY}&format=json&limit=1`;
            try {
                const r = await fetch(url);
                const d = await r.json();
                const track = d.recenttracks?.track?.[0];
                if (!track) return;

                const isNowPlaying = track['@attr'] && track['@attr'].nowplaying === 'true';

                if (isNowPlaying) {
                    if (isIdle) {
                        isIdle = false;
                        fadeOverlay.classList.remove('black');
                        setStatus("Music detected - Waking up");
                    }
                    if (idleTimer) { clearTimeout(idleTimer); idleTimer = null; }

                    const uniqueId = track.name + track.artist['#text'];
                    if (uniqueId !== currentTrackId) {
                        currentTrackId = uniqueId;
                        setStatus(`Nieuwe track: ${track.name}`);
                        await processTrack(track);
                    }
                } else {
                    // Geen muziek aan het spelen
                    if (!isIdle && !idleTimer) {
                        setStatus("Geen muziek - Timer gestart (60s)");
                        idleTimer = setTimeout(() => {
                            isIdle = true;
                            stopSlideshow();
                            fadeOverlay.classList.add('black'); // Fade naar zwart
                            setStatus("Idle Mode - Scherm zwart");
                        }, 60000); 
                    }
                }
            } catch (e) { setStatus("API Error"); }
        }

        async function processTrack(track) {
            const artist = track.artist['#text'];
            const album = track.album['#text'];
            const title = track.name;
            const theme = findTheme(artist, album, title);

            stopSlideshow(); // Stop eventuele vorige slideshows

            if (theme) {
                setStatus(`Thema gevonden: ${theme.folder}`);
                startSlideshow(theme);
            } else {
                setStatus("Geen thema, zoek cover art...");
                const coverUrl = await findHighResCover(artist, title, track.image[3]['#text']);
                transitionToImage(coverUrl);
            }
        }

        function findTheme(artist, album, title) {
            const lowerTitle = title.toLowerCase();
            const lowerArtist = artist.toLowerCase();
            const lowerAlbum = (album || "").toLowerCase();
            
            // Simpelere match logica
            for (const theme of THEMES) {
                if (theme.match.artist?.some(a => lowerArtist.includes(a.toLowerCase()))) return theme;
                if (theme.match.album?.some(al => lowerAlbum.includes(al.toLowerCase()))) return theme;
                if (theme.match.track?.some(t => lowerTitle.includes(t.toLowerCase()))) return theme;
            }
            return null;
        }

        // SLIDESHOW LOGICA
        function startSlideshow(theme) {
            let imageIndex = 1;
            
            // Functie om volgende slide te pakken
            const nextSlide = () => {
                // Randomize of sequentieel? Laten we sequentieel doen met loop
                const imgPath = `${BASE_IMG_PATH}${theme.folder}/${imageIndex}.jpg`;
                
                // Preload afbeelding om flikkering te voorkomen
                const imgLoader = new Image();
                imgLoader.src = imgPath;
                imgLoader.onload = () => {
                    transitionToImage(imgPath);
                    // Verhoog index, als we voorbij count zijn, terug naar 1
                    imageIndex++;
                    if (imageIndex > theme.count) imageIndex = 1;
                };

            };

            // Start direct de eerste
            nextSlide();

            // En herhaal elke 10 seconden
            slideshowTimer = setInterval(nextSlide, 10000);
        }

        function stopSlideshow() {
            if (slideshowTimer) {
                clearInterval(slideshowTimer);
                slideshowTimer = null;
            }
        }

        function transitionToImage(url) {
            let activeEl = activeBgIndex === 1 ? bg1 : bg2;
            let nextEl = activeBgIndex === 1 ? bg2 : bg1;

            nextEl.src = url;
            
            // Zorg dat de nieuwe klaar staat
            nextEl.classList.remove('active', 'exiting');
            nextEl.classList.add('entering');
            
            // De oude gaat weg
            activeEl.classList.remove('entering', 'active');
            activeEl.classList.add('exiting');

            // Timeout om classes definitief om te zetten na de transitie
            setTimeout(() => {
                nextEl.classList.remove('entering');
                nextEl.classList.add('active');
                activeEl.classList.remove('exiting'); // Reset voor volgende keer
            }, 3000); // Moet matchen met CSS transition-speed

            activeBgIndex = activeBgIndex === 1 ? 2 : 1;
        }

        async function findHighResCover(a, t, fallback) {
            // Jouw bestaande cover art functie (iets ingekort)
            const q = encodeURIComponent(`${t} ${a}`);
            try {
                let r = await fetch(`https://corsproxy.io/?https://api.deezer.com/search/track?q=${q}`);
                let d = await r.json();
                if (d.data?.[0]?.album?.cover_xl) return d.data[0].album.cover_xl;
            } catch (e) {}
            return fallback;
        }

        // Start de loop
        fetchLastFm();
        setInterval(fetchLastFm, 5000);

    </script>
</body>
</html>
