<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cinematic Background Engine - Ultimate Debug Edition</title>
    <style>
        :root {
            --blur-amount: 10px;        
            --saturation: 120%;          
            --brightness: 100%;          
            --distortion-amount: 30;    
            --noise-frequency: 0.01;    
            --animation-speed: 60s;      
            --transition-speed: 2.5s;   
            --fade-speed: 2.0s; /* Iets trager voor een mooiere fade-out naar zwart */
        }

        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #000; overflow: hidden; }
        #bg-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; }
        
        /* Fade overlay voor transities en de 60s idle-to-black */
        #fade-overlay { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: #000; 
            opacity: 0; 
            z-index: 100; 
            pointer-events: none; 
            transition: opacity var(--fade-speed) ease-in-out; 
        }
        #fade-overlay.black { opacity: 1; }

        .bg-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; z-index: 1;
            filter: url(#liquid-glass) blur(var(--blur-amount)) saturate(var(--saturation)) brightness(var(--brightness));
            transform: scale(1.2); will-change: transform, opacity;
        }

        @keyframes slowBreath { 0% { transform: scale(1.2) rotate(0deg); } 50% { transform: scale(1.3) rotate(2deg); } 100% { transform: scale(1.2) rotate(0deg); } }
        @keyframes enterZoom { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1.2); opacity: 1; } }
        @keyframes explodeOut { 0% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(4.0); opacity: 0; } }

        .bg-layer.active { opacity: 1; z-index: 5; animation: slowBreath var(--animation-speed) infinite ease-in-out; }
        .bg-layer.entering { opacity: 1; z-index: 4; animation: enterZoom var(--transition-speed) cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .bg-layer.exiting { z-index: 6; animation: explodeOut var(--transition-speed) ease-out forwards; }

        #video-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; z-index: 1; }
        #video-layer.active { opacity: 1 !important; z-index: 10 !important; }
    </style>
</head>
<body>

    <div id="bg-container">
        <div id="fade-overlay"></div>
        <img id="bg1" class="bg-layer" src="" alt="">
        <img id="bg2" class="bg-layer" src="" alt="">
        <video id="video-layer" muted loop playsinline></video>
    </div>

    <svg style="position: absolute; width: 0; height: 0; overflow: hidden;">
        <defs>
            <filter id="liquid-glass" x="-20%" y="-20%" width="140%" height="140%">
                <feTurbulence type="fractalNoise" baseFrequency="0.01" numOctaves="2" result="noise" id="svg-turbulence" />
                <feDisplacementMap in="SourceGraphic" in2="noise" scale="30" xChannelSelector="R" yChannelSelector="G" id="svg-displacement" />
            </filter>
        </defs>
    </svg>

    <script>
        const LASTFM_API_KEY = "6c9c00e45e415acfc71a217c7ba023c8";
        const LASTFM_USER = "Hollander33";
        const BASE_VIDEO_URL = "http://46.224.45.79:8888/videos/";

        const VIDEO_BACKGROUNDS = [
          {
            video: "HARRY_POTTER.MP4",
            match: {
              artist: ["John Williams", "Patrick Doyle", "Nicholas Hooper", "Alexandre Desplat"],
              album: ["Harry Potter", "Philosopher's Stone", "Chamber of Secrets", "Prisoner of Azkaban", "Goblet of Fire", "Order of the Phoenix", "Half-Blood Prince", "Deathly Hallows"],
              track: ["Hedwig's Theme", "Snape to Malfoy Manor", "Leaving Hogwarts", "Harry's Wondrous World", "The Face of Voldemort", "The Quidditch Match", "Buckbeak's Flight", "Window to the Past", "Double Trouble", "A Window to the Past", "The Hogwarts Hymn", "Dumbledore's Farewell", "Lily's Theme", "Statues", "Courtyard Apocalypse", "A New Beginning"]
            }
          },
          {
            video: "DUNE.MP4",
            match: { 
                artist: ["Hans Zimmer"], 
                album: ["Dune", "Dune: Part Two", "The Dune Sketchbook", "Dune (Original Motion Picture Soundtrack)"], 
                track: ["Paul's Dream", "Ripples in the Sand", "Gom Jabbar", "Dream of Arrakis", "Worm Ride", "Kiss the Ring", "Herald of the Change", "Leaving Caladan", "Beginnings Are Such Delicate Times", "Eclipse", "Lisan al-Gaib", "Resurrection", "Only I Will Remain", "The Voice in My Head", "Ornithopter"] 
            }
          },
          {
            video: "INCEPTION.MP4",
            match: { 
                artist: ["Hans Zimmer"], 
                album: ["Inception", "Inception (Music from the Motion Picture)"], 
                track: ["Time", "Dream Is Collapsing", "Mombasa", "Old Souls", "Waiting for a Train"] 
            }
          },
          {
            video: "TENET.MP4",
            match: { 
                artist: ["Ludwig GÃ¶ransson", "Travis Scott"], 
                album: ["Tenet", "Tenet (Original Motion Picture Soundtrack)"], 
                track: ["Rainy Night In Tallinn", "Windmills", "Meeting Neil", "Posterity", "The Plan (From the Motion Picture 'Tenet')", "The Protagonist", "Foils", "Sator", "Trucks In Place", "Red Room Blue Room", "Inversion"] 
            }
          },
          {
            video: "F1.MP4",
            match: { 
                artist: ["Brian Tyler"], 
                album: ["Formula 1", "F1 Theme", "F1 The Album"], 
                track: ["Formula 1 Theme", "F1 Main Title", "Formula 1 Theme (Live)", "Slow", "Fast", "Grid", "Podium", "The Start", "Final Lap", "Checkered Flag", "Paddock", "Pit Stop", "Engine Roar"] 
            }
          },
          {
              video: "THE_ADVENTURES_OF_TINTIN.MP4",
              match: { 
                  artist: ["John Williams"], 
                  album: ["The Adventures of Tintin", "The Adventures of Tintin: The Secret of the Unicorn"], 
                  track: ["The Adventures of Tintin", "Sir Francis and the Unicorn", "Snowy's Theme", "The Secret of the Unicorn", "Tintin", "Captain Haddock", "Sir Francis Drake", "The Milanese Nightingale", "Pursuit on the Karoudjan", "Red Rackham's Curse", "The Adventure Continues", "Bagghar", "Dueling Pirates"] 
              }
          },
          {
            video: "GAME_OF_THRONES.MP4",
            match: {
              artist: ["Ramin Djawadi"],
              album: ["Game of Thrones", "Game of Thrones Season 1-8"],
              track: ["Light of the Seven", "Game Of Thrones - Main Theme", "The Night King", "Winter Is Coming", "Mhysa", "The Rains of Castamere", "Goodbye Brother", "A Lannister Always Pays His Debts", "Dracarys", "Chaos Is a Ladder", "You Know Nothing", "Jenny of Oldstones", "The Iron Throne", "The Children", "The Winds of Winter", "Battle of the Bastards", "Against All Odds", "The Army of the Dead", "Seven Nation Army", "Truth", "Hear Me Roar", "The Spoils of War", "Hold the Door", "Blood of My Blood", "Dance of Dragons", "Khaleesi", "Things I Do for Love", "The Bells", "Not Today", "Blood of the Dragon", "You'll Be Queen One Day", "You Win or You Die"]
            }
          },
          {
            video: "HOUSE_OF_THE_DRAGON.MP4",
            match: { 
                artist: ["Ramin Djawadi"], 
                album: ["HOUSE OF THE DRAGON", "House of the Dragon: Season 1"], 
                track: ["All Must Choose", "The Prince That Was Promised", "Protector of the Realm", "The Crown of Jaeharys", "Dragons Will Reign", "Bloodlines Will Burn", "The Green Council", "The Black Queen", "Fire and Blood", "Reign of the Targaryens", "Fate of the Kingdoms", "A Dance of Dragons"] 
            }
          },
          {
            video: "INTERSTELLAR.MP4",
            match: { 
                artist: ["Hans Zimmer"], 
                album: ["Interstellar"], 
                track: ["No Time for Caution", "Cornfield Chase", "Day One", "Mountains", "S.T.A.Y.", "Where We're Going", "Coward", "Detach", "First Step", "Message From Home", "The Wormhole", "Dust", "Afraid of Time", "Stay", "Quantum Theory"] 
            }
          },
          {
            video: "OPPENHEIMER.MP4",
            match: { 
                artist: ["Ludwig GÃ¶ransson"], 
                album: ["Oppenheimer", "Oppenheimer: Original Motion Picture"], 
                track: ["Destroyer of Worlds", "FREEPORT", "Can You Hear the Music", "TRUCKS IN PLACE", "American Prometheus", "Quantum Mechanics", "Fusion", "Fission", "Manhattan Project", "Los Alamos", "The Trial", "Theory", "Dr. Oppenheimer", "Kitty Comes to Testify", "Something More Important"] 
            }
          },
          {
            video: "THE_DARK_KNIGHT_TRILOGY.MP4",
            match: {
              artist: ["Hans Zimmer", "James Newton Howard", "Hanz Zimmer"],
              album: ["The Dark Knight", "The Batman Trilogy", "Batman Begins", "The Dark Knight Rises", "The Dark Knight (Collectors Edition)"],
              track: ["A Dark Knight", "Aggressive Expansion", "A Watchful Guardian", "Batman Begins End Credits", "Antrozous", "Molossus", "Rise", "Introduce a Little Anarchy", "Risen From Darkness", "I'm Not a Hero", "Bank Robbery (Prologue)", "Macrotus", "Like a Dog Chasing Cars", "Descent Into Mystery", "Why Do We Fall?", "Gotham's Reckoning", "Mind If I Cut In?", "Imagine the Fire", "The Fire Rises", "Fear Will Find You"]
            }
          },
          {
            video: "MAN_OF_STEEL.MP4",
            match: { 
                artist: ["Hans Zimmer"], 
                album: ["Man of Steel", "Man of Steel (Original Motion Picture Soundtrack)"], 
                track: ["Flight (Man of Steel)", "What Are You Going to Do When You Are Not Saving the World?", "Look to the Stars", "Oil Rig", "Sent Here for a Reason", "If You Love These People", "Krypton's Last", "I Will Find Him", "Terraforming", "Launch", "General Zod", "Arcade", "This Is Clark Kent"] 
            }
          }
        ];

        let currentTrackId = "";
        let currentMode = ""; 
        let activeBgIndex = 0; 
        
        // Idle tracking
        let idleTimer = null;
        let isFadedOut = false;

        const fadeOverlay = document.getElementById("fade-overlay");
        const videoLayer = document.getElementById("video-layer");
        const bg1 = document.getElementById("bg1");
        const bg2 = document.getElementById("bg2");

        console.log("%c ðŸš€ Cinematic Engine - DEBUG EDITION gestart. ", "background: #111; color: #00ff00; font-weight: bold; padding: 5px;");

        async function fetchLastFm() {
            const url = `https://ws.audioscrobbler.com/2.0/?method=user.getrecenttracks&user=${LASTFM_USER}&api_key=${LASTFM_API_KEY}&format=json&limit=1`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                const track = data.recenttracks?.track?.[0];
                
                if (!track) return;

                // Check of de track op dit moment wordt afgespeeld
                const isNowPlaying = track['@attr'] && track['@attr'].nowplaying === 'true';

                if (isNowPlaying) {
                    // Er speelt muziek: reset timer en haal overlay weg indien nodig
                    if (idleTimer) {
                        clearTimeout(idleTimer);
                        idleTimer = null;
                    }

                    if (isFadedOut) {
                        fadeOverlay.classList.remove('black');
                        isFadedOut = false;
                        if (currentMode === 'video') videoLayer.play();
                        console.log("%c â–¶ï¸ Muziek hervat: Fade-out geannuleerd.", "color: #00ff00;");
                    }

                    const uniqueId = track.name + track.artist['#text'];
                    if (uniqueId !== currentTrackId) {
                        currentTrackId = uniqueId;
                        console.group(`%c ðŸŽµ NIEUWE TRACK: ${track.name} `, "background: #222; color: #fff; padding: 5px; font-size: 1.1em;");
                        console.info(`ðŸ‘¤ Artist: ${track.artist['#text']}`);
                        console.info(`ðŸ’¿ Album: ${track.album['#text']}`);
                        await processTrack(track);
                        console.groupEnd();
                    }
                } else {
                    // Geen actieve muziek: start timer voor fade naar zwart
                    if (!idleTimer && !isFadedOut) {
                        console.warn("%c â¸ï¸ Geen actieve muziek. Scherm wordt over 60 sec zwart...", "color: #ffa500;");
                        idleTimer = setTimeout(() => {
                            fadeOverlay.classList.add('black');
                            isFadedOut = true;
                            videoLayer.pause(); // Stop video om CPU/GPU te besparen
                            console.log("%c ðŸŒ‘ Scherm op zwart na 60 sec inactiviteit.", "background: #000; color: #fff;");
                        }, 60000); 
                    }
                }
            } catch (e) { console.error("âŒ Last.fm Error:", e); }
        }

        async function processTrack(track) {
            const artist = track.artist['#text'];
            const album = track.album['#text'];
            const title = track.name;
            const matchedVideo = findMatchingVideo(artist, album, title);

            if (matchedVideo) {
                const fullUrl = BASE_VIDEO_URL + matchedVideo;
                console.info(`%c ðŸ† WINNAAR: ${matchedVideo}`, "color: #00ff00; font-weight: bold; font-size: 1.2em;");
                if (currentMode !== 'video' || videoLayer.src !== fullUrl) {
                    await runFadeToBlack(() => { playVideo(fullUrl); currentMode = 'video'; });
                }
            } else {
                console.info("%c ðŸ§¹ Geen video match gevonden. Start cover art zoektocht...", "color: #ffa500;");
                const highResImage = await findHighResCover(artist, title, track.image[3]['#text']);
                
                const imgLoader = new Image();
                imgLoader.src = highResImage;
                imgLoader.onload = async () => {
                    console.info("%c ðŸ–¼ï¸ Afbeelding geladen. Start transitie.", "color: #00d2ff;");
                    if (currentMode === 'video') {
                        await runFadeToBlack(() => { transitionToImage(highResImage); currentMode = 'image'; });
                    } else { 
                        transitionToImage(highResImage); 
                        currentMode = 'image'; 
                    }
                };
            }
        }

        async function runFadeToBlack(cb) {
            fadeOverlay.classList.add('black');
            await new Promise(r => setTimeout(r, parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--fade-speed')) * 1000));
            cb();
            setTimeout(() => {
                if (!isFadedOut) fadeOverlay.classList.remove('black');
            }, 50);
        }

        function findMatchingVideo(artist, album, title) {
            const lowerTitle = title.toLowerCase();
            const lowerArtist = artist.toLowerCase();
            const lowerAlbum = (album || "").toLowerCase();

            let bestMatch = null;
            let highestScore = 0;

            console.groupCollapsed("ðŸ” Match Analyse");

            for (const item of VIDEO_BACKGROUNDS) {
                let m = 0;
                let reasons = [];

                if (item.match.artist?.some(a => lowerArtist.includes(a.toLowerCase()))) {
                    m++;
                    reasons.push("Artist");
                }
                
                if (item.match.album?.some(al => lowerAlbum.includes(al.toLowerCase()))) {
                    if (lowerAlbum.includes("f1") || lowerAlbum.includes("formula 1")) {
                         m += 2; 
                         reasons.push("Album (F1 Bonus)");
                    } else {
                         m++;
                         reasons.push("Album");
                    }
                }
                
                if (item.match.track) {
                    if (item.match.track.some(t => t.toLowerCase() === lowerTitle)) {
                        m += 3; 
                        reasons.push("Track (EXACT!)");
                    } 
                    else if (item.match.track.some(t => lowerTitle.includes(t.toLowerCase()))) {
                        m++; 
                        reasons.push("Track (Partial)");
                    }
                }
                
                if (m > 0) {
                    console.log(`Kandidaat: [${item.video}] - Score: ${m} (${reasons.join(", ")})`);
                }

                if (m > highestScore) {
                    highestScore = m;
                    bestMatch = item.video;
                }
            }
            console.groupEnd();
            
            return highestScore >= 2 ? bestMatch : null;
        }

        async function findHighResCover(a, t, fallback) {
    const query = encodeURIComponent(`${t} ${a}`);
    console.groupCollapsed("ðŸ–¼ï¸ High-Res Cover Search");

    // 1. Deezer (Snel en vaak 1000x1000)
    try {
        const r = await fetch(`https://corsproxy.io/?https://api.deezer.com/search/track?q=${query}`);
        const d = await r.json();
        if (d.data?.[0]?.album?.cover_xl) {
            console.info("âœ… Deezer Success");
            console.groupEnd();
            return d.data[0].album.cover_xl;
        }
    } catch (e) {}

    // 2. iTunes (Zeer betrouwbaar, makkelijk te upscalen naar 1000+)
    try {
        const r = await fetch(`https://itunes.apple.com/search?term=${query}&media=music&limit=1`);
        const d = await r.json();
        if (d.results?.[0]) {
            console.info("âœ… iTunes Success");
            console.groupEnd();
            return d.results[0].artworkUrl100.replace('100x100bb', '1200x1200bb');
        }
    } catch (e) {}

    // 3. Cover Art Archive (Soms traag, maar super hoge kwaliteit)
    try {
        const r = await fetch(`https://musicbrainz.org/ws/2/release?query=track:${encodeURIComponent(t)}%20AND%20artist:${encodeURIComponent(a)}&fmt=json&limit=1`);
        const d = await r.json();
        if (d.releases?.[0]) {
            console.info("âœ… Cover Art Archive Success");
            console.groupEnd();
            return `https://coverartarchive.org/release/${d.releases[0].id}/front-1200`;
        }
    } catch (e) {}

    console.log("âŒ Geen High-Res gevonden. Terugvallen op Last.fm.");
    console.groupEnd();
    return fallback;
}

        function transitionToImage(url) {
            videoLayer.classList.remove('active'); videoLayer.pause();
            if (activeBgIndex === 0) { bg1.src = url; bg1.classList.add('active'); activeBgIndex = 1; return; }
            
            let oldBg = activeBgIndex === 1 ? bg1 : bg2;
            let newBg = activeBgIndex === 1 ? bg2 : bg1;
            
            newBg.src = url;
            newBg.classList.remove('active', 'exiting'); 
            oldBg.classList.remove('active', 'entering');
            void newBg.offsetWidth; 
            newBg.classList.add('entering');
            oldBg.classList.add('exiting');
            activeBgIndex = activeBgIndex === 1 ? 2 : 1;
        }

        function playVideo(url) {
            bg1.classList.remove('active'); bg2.classList.remove('active');
            videoLayer.src = url; videoLayer.load();
            videoLayer.play().then(() => videoLayer.classList.add('active')).catch(e => console.error(e));
        }

        fetchLastFm();
        setInterval(fetchLastFm, 5000);
    </script>
</body>
</html>


